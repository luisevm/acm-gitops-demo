apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: env-bound-placement
  namespace: acm-policies
spec:
  predicates:
  - requiredClusterSelector:
      labelSelector:
        matchExpressions:
        - key: environment
          operator: In
          values:
          - prod
---
apiVersion: policy.open-cluster-management.io/v1
kind: PlacementBinding
metadata:
  name: cert-manager-binding
  namespace: acm-policies
placementRef:
  apiGroup: cluster.open-cluster-management.io
  kind: Placement
  name: env-bound-placement
subjects:
- apiGroup: policy.open-cluster-management.io
  kind: PolicySet
  name: cert-manager
---
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/description: Deploys example CA based ClusterIssuer
    policy.open-cluster-management.io/standards: NIST SP 800-53
  labels:
    policy_gen.name: cert-manager-operator
  name: cert-manager-clusterissuer
  namespace: acm-policies
spec:
  dependencies:
  - apiVersion: policy.open-cluster-management.io/v1
    compliance: Compliant
    kind: Policy
    name: cert-manager-operator
    namespace: acm-policies
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: ca-clusterissuer-secret
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            data:
              tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURuVENDQW9XZ0F3SUJBZ0lVQTJRc2Vpd0xMSTVBTWJDYnVzTk9DT2dEa2pNd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1hqRUxNQWtHQTFVRUJoTUNWVk14RGpBTUJnTlZCQWNNQlZCeWIzWnZNU0l3SUFZRFZRUUtEQmxVUVUwZwpVMmxuYm1sdVp5QkJkWFJvYjNKcGRIa2dTVzVqTVJzd0dRWURWUVFEREJKaWNua3RkR0Z0TG5KbFpHaGhkQzVqCmIyMHdIaGNOTWpReE1qRTFNakEwTVRFMVdoY05ORGt4TWpFMU1qQTBNVEUxV2pCZU1Rc3dDUVlEVlFRR0V3SlYKVXpFT01Bd0dBMVVFQnd3RlVISnZkbTh4SWpBZ0JnTlZCQW9NR1ZSQlRTQlRhV2R1YVc1bklFRjFkR2h2Y21sMAplU0JKYm1NeEd6QVpCZ05WQkFNTUVtSnllUzEwWVcwdWNtVmthR0YwTG1OdmJUQ0NBU0l3RFFZSktvWklodmNOCkFRRUJCUUFEZ2dFUEFEQ0NBUW9DZ2dFQkFJaFRlQzdEendtTmpaZ3ZzYllXeVRSVzdLaWs3bDc4ZjU0T0RLTDEKcVVETENBUEtsbUE2TFdoci81K0swV0R2SmJYREJ0NTVJaE5HelNxNURObmRiWEFCSWtGbjQzV1ZQcjlOdGxBSApVUlhUR1kwcEsxcVQrNXZwRllHRzRrbWRFQk1hZ1RtWVdWSXUrSkpyQ2N3Y1ZHTXdELzlvMlVxYzNxNFBxaUZ5ClpvOCtjcElNTld0c1hYQ3VxeWNlbW9lcU9jNEl1QlVtM3lybmREMVRRMUFsUkxDVmFnL1k4T1ZvS2Zob2kwZ0kKSDZaMnI5VVBHUGJaVkF4NDFicFVGL3FwNWNDVzZTV20vZ0I4NDVZbFNPNks2dHJvTmFYMjg1RGV3Qy8wSExPWAp2V2Fzbm1sanIyNVBvVmFaaUtsZnNtRHk0ZGZFeURQVURWLzcrVlVObm9GTSs0OENBd0VBQWFOVE1GRXdIUVlEClZSME9CQllFRkhqZXNiR2JMUTlNdk1aOFI0Q2VZWkdScjY5RU1COEdBMVVkSXdRWU1CYUFGSGplc2JHYkxROU0Kdk1aOFI0Q2VZWkdScjY5RU1BOEdBMVVkRXdFQi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQgpBQXM4aDg3ek1wRFJrWW5XUy9FZXZRcmczK3doc2x4ZHJnUHZkQzBwTGFocVA2VlJNZDQ5aWRRdmZpQnRGMzlhCmJXQndGSENtSXFKK3cxM01ib3lEUVphb0xvNENjdllRa245UkRHY0MyZmxJQ3ZFTkcwdGZpWllmZ0R2bm9UcnUKeWFuSGxJK3hvRjdhcnJxL0FBdlJkT245MXcxWUZOSi93enpZajZhd2g4VFBzVkxkMlVsbmkrS2d5Q1VCU1lnQQpkY3VSam9tNnRXdVNjZ2k3S1lLZ2d5VVR4Y3lVT3hRaDVLRmtFSFZyM0o2ZGVYTFV2Wk0xUkFxY003MU8yTUVQClR0bmZ6c2ZyNmkrTzJSaE51Y2MyZk02YTc1R29ob3lUUlQwR0Y5TWdpekx1bk1CNzBJS3BGNlorRVVWT1NOSDkKdmVFOEhrYjkzb25jTlNQMTF6ekVrSlE9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0=
              tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQ0lVM2d1dzg4SmpZMlkKTDdHMkZzazBWdXlvcE81ZS9IK2VEZ3lpOWFsQXl3Z0R5cFpnT2kxb2EvK2ZpdEZnN3lXMXd3YmVlU0lUUnMwcQp1UXpaM1cxd0FTSkJaK04xbFQ2L1RiWlFCMUVWMHhtTktTdGFrL3ViNlJXQmh1SkpuUkFUR29FNW1GbFNMdmlTCmF3bk1IRlJqTUEvL2FObEtuTjZ1RDZvaGNtYVBQbktTRERWcmJGMXdycXNuSHBxSHFqbk9DTGdWSnQ4cTUzUTkKVTBOUUpVU3dsV29QMlBEbGFDbjRhSXRJQ0IrbWRxL1ZEeGoyMlZRTWVOVzZWQmY2cWVYQWx1a2xwdjRBZk9PVwpKVWp1aXVyYTZEV2w5dk9RM3NBdjlCeXpsNzFtcko1cFk2OXVUNkZXbVlpcFg3Smc4dUhYeE1nejFBMWYrL2xWCkRaNkJUUHVQQWdNQkFBRUNnZ0VBTlZ4YXRBOWYrRkRJaGpQUS8wRy9Bdll0VHp1enRFbG9XSUVPVURFUlRYUEwKVU5TWTlOU0ExcGxEWnZzS3hzTUZBemJ4OXQzNlNRcFRIM0JzaDlDazJBMFJrQUZ1cHFWQytOV2QwWWh6cERQTApraFgxeXRBVzBlbXp5YzMyd0RLeXlvOTYyb1Q0SFhPV1I1V1BNYTQ3RjlJRnlRY00ycWc1ZjI5UlBDTlA0cXhRCklyU3pGZTIrWnhibC9lZW41b09YZGNhQ1hsT2xKcmlvQlpTOC9QK0hzNGJCTHo4MXkvam9GVWNTWk1sWloxRHkKSSs3VHhXdm00S0lreHdDSEdFSnRHb0dLdk0vRzRxSmVZdnFmbVYxRU5YeFNhaEphY0NCT2dpeGdMY2tZZjk5MQo3VzlER3RNdklPMGgzUGFlVGwxMEdlQlNsL0dPNDJINDZWaVRpai9EWlFLQmdRQzhRU2xDNDNnS0FLbzZYNStuCllQaDlLbjZ6bjB0QzRxcFJmQ1IvQTcyWHFXQStmMUUrN2V5cTZYQ3RXZTNDcnVTL3NZQWxTcm51bksySFVDUGoKRy9iUzZWMDVkRjJIbG9tZUNIbTlRK3RrYmV4bmJIekNzbUdDSkV1aEc0Ris1WVEva1lMSmFycHRVQUNpTzJwVgpxaUVTNGlpZHJZYW1WZDFhZUN2RGZxNmZ3d0tCZ1FDNVltMWNVVjQ0YjBMSmNINHJHWWJBRXJkb2JBbXc4alpQCjlGMTRadGgzczdNTGdCUnc3Rno1TG1IYm16U2ZWWlZ5UDQreGV3bGRDZDk3RjNyWTlKNk5VMEVvbGdoZnd0N1IKaEpRaC81SDkrNmFXR2NaUFNDelBtM01NZ1ZzVFBSS2QrWkFDVE5Sb3VMcTJmekxDTVBKT245SmNPdUt3SXAyagpHeDZtNTJHa1JRS0JnRlp1TUV4MmRTRmFoczFBSStQTUFLb3V2WGNvZG54aDVzSjhsYUQvRGFlNDZ1Z211aDJEClRQcDNMUFZaNlhCTnJkWlkzelcvNWplb0ZYK2ZpcXAxcDAvVU5xbnZSQlhCUnJPWXZwUG53QVllOWIvU0xrR1IKZG5VeXhzcFQvNU5NT3ZpWWpReCtoTk0xUE9VL0ZDWDZjeTdoU0xhRCtlTWFYd052VXVCeHBDalRBb0dCQUtYZAp6L1ZTaEJmQVRLUkpOMG0rdkJic2FCZFEydGJyei9aM3NJM0NqeG1DdWNhbllTS3NDSCtXcFUzRXJ5K0Vkb05UCkpYRHBvYllSMkZlYzZYaG1YZG9hekdqUTNFczU0dnpaUDJTdjh1S3BIeUtiaXhoeWZrMStTMUM4Q0UzTlRmUDAKVDRvUFRka290ejREenRsNnk4SFhNM0w3Nk1rcEg1dkk3d0xzY1N0MUFvR0JBSXdyMHdCUDlUVVovdG9Sb3huTQppejJkejR2YTJuTzlNQXFCdHpTeVR6WWtRN21tMVl0NnhEK1NaMjl6WEpkWis2a3JGTmVGUjcyNnl6YXJndTNQCk1YeFpaU3A5WFlRYnBIWGJ4OEJKajF4V2ZDOUgrZDlXRkNBS1Y3OTRRRGJGYS9KUVd3c28vMTJkOXpBcFBkRlQKSVJ0WnltTjF0MU9HZFl2alk2eVAybWYxCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
            kind: Secret
            metadata:
              name: ca-clusterissuer-tls
              namespace: cert-manager
            type: kubernetes.io/tls
        remediationAction: enforce
        severity: medium
  - extraDependencies:
    - apiVersion: policy.open-cluster-management.io/v1
      compliance: Compliant
      kind: ConfigurationPolicy
      name: ca-clusterissuer-secret
    objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: ca-clusterissuer
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: cert-manager.io/v1
            kind: ClusterIssuer
            metadata:
              name: ca-clusterissuer
            spec:
              ca:
                secretName: ca-clusterissuer-tls
        remediationAction: enforce
        severity: medium
  remediationAction: enforce
---
apiVersion: policy.open-cluster-management.io/v1
kind: Policy
metadata:
  annotations:
    policy.open-cluster-management.io/categories: CM Configuration Management
    policy.open-cluster-management.io/controls: CM-2 Baseline Configuration
    policy.open-cluster-management.io/description: Installs cert-manager operator
      and monitoring
    policy.open-cluster-management.io/standards: NIST SP 800-53
  labels:
    policy_gen.name: cert-manager-operator
  name: cert-manager-operator
  namespace: acm-policies
spec:
  disabled: false
  policy-templates:
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: cert-manager-operator
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: Namespace
            metadata:
              labels:
                openshift.io/cluster-monitoring: "true"
              name: cert-manager-operator
        remediationAction: enforce
        severity: medium
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: trusted-ca-configmap
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: ConfigMap
            metadata:
              labels:
                config.openshift.io/inject-trusted-cabundle: "true"
              name: trusted-ca
              namespace: cert-manager
        remediationAction: enforce
        severity: medium
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1beta1
      kind: OperatorPolicy
      metadata:
        name: cert-manager-operator-install
      spec:
        complianceConfig:
          catalogSourceUnhealthy: NonCompliant
          deploymentsUnavailable: NonCompliant
          upgradesAvailable: Compliant
        complianceType: musthave
        remediationAction: enforce
        removalBehavior:
          clusterServiceVersions: Delete
          customResourceDefinitions: Delete
          operatorGroups: DeleteIfUnused
          subscriptions: Delete
        severity: critical
        subscription:
          channel: stable-v1.17
          config:
            env:
            - name: TRUSTED_CA_CONFIGMAP_NAME
              value: trusted-ca
          name: openshift-cert-manager-operator
          namespace: cert-manager-operator
          source: redhat-operators
          sourceNamespace: openshift-marketplace
        upgradeApproval: Automatic
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: cert-manager-status
      spec:
        object-templates-raw: |
          ## Create a CompilianceType objectDefinition for each deployment
          {{- range $dep := (lookup "apps/v1" "Deployment" "cert-manager" "").items }}
          - complianceType: musthave
            objectDefinition:
              kind: Deployment
              apiVersion: apps/v1
              metadata:
                namespace: {{ $dep.metadata.namespace }}
                name: {{ $dep.metadata.name }}
              status:
                replicas: '{{ $dep.spec.replicas | default 1 | toInt }}'
                updatedReplicas: '{{ $dep.spec.replicas | default 1 | toInt }}'
                readyReplicas: '{{ $dep.spec.replicas | default 1 | toInt }}'
                availableReplicas: '{{ $dep.spec.replicas | default 1 | toInt }}'
                conditions:
                  {{- range $c := $dep.status.conditions }}
                    {{- $_ := set $c "status" "True" }}
                  - {{ $c | toRawJson | toLiteral }}
                  {{- end }}
          {{- else }}
            {{- fail "There are zero deployments in cert-manager namespace."}}
          {{- end }}
        remediationAction: InformOnly
        severity: medium
  - objectDefinition:
      apiVersion: policy.open-cluster-management.io/v1
      kind: ConfigurationPolicy
      metadata:
        name: cert-manager-namespace
      spec:
        object-templates:
        - complianceType: musthave
          objectDefinition:
            apiVersion: v1
            kind: Namespace
            metadata:
              labels:
                openshift.io/cluster-monitoring: "true"
              name: cert-manager
        remediationAction: enforce
        severity: medium
---
apiVersion: policy.open-cluster-management.io/v1beta1
kind: PolicySet
metadata:
  name: cert-manager
  namespace: acm-policies
spec:
  policies:
  - cert-manager-operator
  - cert-manager-clusterissuer
